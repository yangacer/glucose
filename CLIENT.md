# mTLS Client Configuration Guide

This guide explains how to configure your client to connect to the Glucose Monitor application using mutual TLS (mTLS) authentication.

## Overview

**What is mTLS?**
Mutual TLS (mTLS) is a security protocol where both the client and server authenticate each other using X.509 certificates. This ensures that:
- The server verifies you are an authorized client
- You verify you're connecting to the legitimate server
- All communication is encrypted

**Prerequisites:**
- Client certificate files generated by `generate-certs.sh`
- Access to the CA certificate: `certs/ca/ca-cert.pem`
- Your client certificate: `certs/clients/client-<name>-cert.pem`
- Your private key: `certs/clients/client-<name>-key.pem`
- PKCS#12 bundle (for browsers): `certs/clients/client-<name>.p12`

---

## Browser Configuration

### Chrome / Chromium / Edge

**Import Certificate:**

1. Open Settings  Privacy and security  Security  Manage certificates
2. Navigate to "Your certificates" tab
3. Click "Import"
4. Select your `client-<name>.p12` file
5. Enter the password (if you set one during generation)
6. Click "OK"

**Access the Application:**
- Navigate to `https://localhost:8443`
- Browser will prompt you to select a certificate
- Choose your imported certificate
- Click "OK" to proceed

**Chrome Command Line (Alternative):**
```bash
google-chrome \
  --user-data-dir=/tmp/chrome-mtls \
  https://localhost:8443
```

### Firefox

**Import Certificate:**

1. Open Settings  Privacy & Security  Certificates  View Certificates
2. Click "Your Certificates" tab
3. Click "Import"
4. Select your `client-<name>.p12` file
5. Enter the password (if set)
6. Click "OK"

**Import CA Certificate:**
1. Go to "Authorities" tab
2. Click "Import"
3. Select `certs/ca/ca-cert.pem`
4. Check "Trust this CA to identify websites"
5. Click "OK"

**Access the Application:**
- Navigate to `https://localhost:8443`
- Select your certificate when prompted
- Click "OK"

### Safari (macOS)

**Import Certificate:**

1. Double-click `client-<name>.p12` file
2. Keychain Access will open
3. Select "login" keychain
4. Enter the password (if set)
5. Click "OK"

**Trust the CA Certificate:**
1. Double-click `ca-cert.pem` in Keychain Access
2. Expand "Trust" section
3. Set "Secure Sockets Layer (SSL)" to "Always Trust"
4. Close the window and authenticate

**Access the Application:**
- Navigate to `https://localhost:8443`
- Select your certificate when prompted

---

## Mobile Devices

### iOS (iPhone / iPad)

**Prerequisites:**
- Transfer `client-<name>.p12` and `ca-cert.pem` files to your iOS device
- Use AirDrop, email attachment, or cloud storage

**Install Client Certificate:**

1. **Transfer the Certificate:**
   - Email the `.p12` file to yourself, or use AirDrop
   - Tap the `.p12` file attachment

2. **Install Profile:**
   - Tap "Install" when prompted
   - Enter your device passcode
   - Enter certificate password (if set during generation)
   - Tap "Install" again to confirm
   - Tap "Done"

3. **Trust the Certificate:**
   - Go to Settings  General  About  Certificate Trust Settings
   - Enable full trust for your client certificate
   - Tap "Continue" to confirm

**Install CA Certificate:**

1. **Transfer CA Certificate:**
   - Email `ca-cert.pem` or use AirDrop
   - Tap the file to download

2. **Install CA Profile:**
   - Go to Settings  Profile Downloaded or Settings  General  VPN & Device Management
   - Tap the CA certificate profile
   - Tap "Install" (enter passcode if prompted)
   - Tap "Install" again to confirm
   - Tap "Done"

3. **Trust the CA:**
   - Go to Settings  General  About  Certificate Trust Settings
   - Enable full trust for the CA certificate (scroll down to find it)
   - Tap "Continue" when warned

**Access the Application:**
1. Open Safari
2. Navigate to `https://<server-ip>:8443`
   - Replace `<server-ip>` with your server's IP address (not localhost)
3. Select your certificate when prompted
4. Tap "Continue" or "Allow"

**Troubleshooting iOS:**
- If certificate isn't trusted: Verify it's enabled in Certificate Trust Settings
- If Safari doesn't prompt: Try clearing Safari cache (Settings  Safari  Clear History)
- Connection fails: Ensure your device is on the same network as the server
- Certificate not found: Verify profile is installed in Settings  General  VPN & Device Management

---

### Android

**Prerequisites:**
- Transfer `client-<name>.p12` and `ca-cert.pem` files to your Android device
- Use email, USB transfer, or cloud storage

**Install Certificates:**

1. **Transfer Certificate Files:**
   - Email both files to yourself, or copy via USB
   - Save them to your device's Downloads folder

2. **Install Client Certificate (.p12):**
   - Go to Settings  Security  Encryption & credentials
   - (On some devices: Settings  Biometrics and security  Other security settings)
   - Tap "Install a certificate"  "VPN & app user certificate"
   - Tap the menu icon ()  Show internal storage
   - Navigate to Downloads folder
   - Tap your `client-<name>.p12` file
   - Enter the password (if set)
   - Give it a name (e.g., "Glucose Client")
   - Tap "OK"

3. **Install CA Certificate:**
   - Go to Settings  Security  Encryption & credentials
   - Tap "Install a certificate"  "CA certificate"
   - Tap "Install anyway" when warned
   - Navigate to your `ca-cert.pem` file
   - Tap to install
   - Enter device PIN/password if prompted

**Alternative Method (Newer Android versions):**

1. **Open Files app** or Downloads
2. **Tap the .p12 file** directly
3. Android will prompt: "Name the certificate"
4. Enter a name and tap "OK"
5. Set credential use to "VPN and apps"
6. Repeat for CA certificate

**Access the Application:**

**Method 1: Chrome Browser**
1. Open Chrome
2. Navigate to `https://<server-ip>:8443`
   - Replace `<server-ip>` with your server's IP address
3. Select your certificate when prompted
4. Tap "Allow"

**Method 2: Firefox Browser**
1. Open Firefox
2. Navigate to `https://<server-ip>:8443`
3. Accept the security exception if prompted
4. Select certificate when requested

**Verify Certificate Installation:**
1. Go to Settings  Security  Encryption & credentials
2. Tap "User credentials" to see client certificate
3. Tap "Trusted credentials"  "User" tab to see CA certificate

**Troubleshooting Android:**
- Certificate not found: Check Settings  Security  User credentials
- Connection refused: Verify server IP and port are correct
- Certificate expired: Check certificate validity period
- Chrome doesn't prompt: Clear Chrome data (Settings  Apps  Chrome  Storage  Clear data)
- Security warning: Ensure CA certificate is installed under "Trusted credentials"

**Android Version-Specific Notes:**
- **Android 11+**: May require installing via Settings only (direct file tap may not work)
- **Android 12+**: Enhanced security may show additional warnings
- **Samsung devices**: Path may be Settings  Biometrics and security  Other security settings
- **OnePlus/Oppo**: May be under Settings  Password & security  Credentials

---

## Network Access Notes for Mobile Devices

**Important:** Mobile devices cannot use `localhost`. You must:

1. **Find your server's IP address:**
   ```bash
   # On Linux/macOS
   ip addr show | grep inet
   # or
   ifconfig | grep inet
   
   # On Windows
   ipconfig
   ```

2. **Generate certificates with your server IP:**
   - When running `./generate-certs.sh`, provide your server's IP address when prompted
   - Example: If your server IP is `192.168.1.100`, enter that value
   - The certificate will include this IP in the Subject Alternative Name (SAN)
   - **Important:** Without this, browsers will show certificate errors when accessing via IP

3. **Use the IP in URLs:**
   - Instead of `https://localhost:8443`
   - Use `https://192.168.1.100:8443` (replace with your actual IP)

4. **Firewall Configuration:**
   - Ensure server allows connections from LAN
   - Port 8443 must be accessible on the network
   - Check firewall rules on the server

5. **Same Network:**
   - Mobile device must be on the same WiFi/network as server
   - Cannot access from cellular data unless server is publicly accessible

6. **Public IP Considerations:**
   - If using a public IP address, include it when generating certificates
   - Consider security implications of exposing the server publicly
   - Use strong firewall rules and consider VPN for remote access

---

## Command Line Tools

### curl

**Basic Request:**
```bash
curl https://localhost:8443/ \
  --cert certs/clients/client-<name>-cert.pem \
  --key certs/clients/client-<name>-key.pem \
  --cacert certs/ca/ca-cert.pem
```

**POST Request Example:**
```bash
curl -X POST https://localhost:8443/api/glucose \
  --cert certs/clients/client-<name>-cert.pem \
  --key certs/clients/client-<name>-key.pem \
  --cacert certs/ca/ca-cert.pem \
  -H "Content-Type: application/json" \
  -d '{"timestamp":"2024-01-15T10:30:00","level":120}'
```

**Save Credentials (for convenience):**
```bash
# Add to ~/.curlrc
cert = "/path/to/certs/clients/client-<name>-cert.pem"
key = "/path/to/certs/clients/client-<name>-key.pem"
cacert = "/path/to/certs/ca/ca-cert.pem"
```

### wget

```bash
wget https://localhost:8443/ \
  --certificate=certs/clients/client-<name>-cert.pem \
  --private-key=certs/clients/client-<name>-key.pem \
  --ca-certificate=certs/ca/ca-cert.pem
```

### OpenSSL (Test Connection)

```bash
openssl s_client \
  -connect localhost:8443 \
  -cert certs/clients/client-<name>-cert.pem \
  -key certs/clients/client-<name>-key.pem \
  -CAfile certs/ca/ca-cert.pem
```

---

## Programming Languages

### Python (requests library)

```python
import requests

response = requests.get(
    'https://localhost:8443/',
    cert=(
        'certs/clients/client-<name>-cert.pem',
        'certs/clients/client-<name>-key.pem'
    ),
    verify='certs/ca/ca-cert.pem'
)

print(response.text)
```

**Python (urllib):**
```python
import urllib.request
import ssl

context = ssl.create_default_context(cafile='certs/ca/ca-cert.pem')
context.load_cert_chain(
    certfile='certs/clients/client-<name>-cert.pem',
    keyfile='certs/clients/client-<name>-key.pem'
)

with urllib.request.urlopen('https://localhost:8443/', context=context) as response:
    print(response.read().decode())
```

### JavaScript / Node.js

```javascript
const https = require('https');
const fs = require('fs');

const options = {
    hostname: 'localhost',
    port: 8443,
    path: '/',
    method: 'GET',
    cert: fs.readFileSync('certs/clients/client-<name>-cert.pem'),
    key: fs.readFileSync('certs/clients/client-<name>-key.pem'),
    ca: fs.readFileSync('certs/ca/ca-cert.pem')
};

const req = https.request(options, (res) => {
    console.log('Status:', res.statusCode);
    res.on('data', (d) => {
        process.stdout.write(d);
    });
});

req.on('error', (e) => {
    console.error(e);
});

req.end();
```

---

## Testing Your Connection

### Verify Certificate Installation

**Check certificate details:**
```bash
openssl x509 -in certs/clients/client-<name>-cert.pem -text -noout
```

**Verify certificate chain:**
```bash
openssl verify -CAfile certs/ca/ca-cert.pem certs/clients/client-<name>-cert.pem
```

### Test Server Connection

**Simple connectivity test:**
```bash
curl -v https://localhost:8443/ \
  --cert certs/clients/client-<name>-cert.pem \
  --key certs/clients/client-<name>-key.pem \
  --cacert certs/ca/ca-cert.pem
```

**Expected output:**
- `SSL connection using TLS...`
- `Server certificate: CN=localhost`
- `HTTP/1.0 200 OK`

---

## Troubleshooting

### Certificate Not Recognized

**Error:** `SSL certificate problem: unable to get local issuer certificate`

**Solution:**
- Ensure CA certificate is installed/specified
- For browsers: Import CA certificate into trusted authorities
- For curl: Use `--cacert certs/ca/ca-cert.pem`

### Certificate Expired

**Error:** `certificate has expired`

**Solution:**
1. Check expiration date:
   ```bash
   openssl x509 -in certs/clients/client-<name>-cert.pem -noout -enddate
   ```
2. Generate new certificate:
   ```bash
   ./generate-certs.sh --client-only --name <name>
   ```

### Connection Refused

**Error:** `Connection refused` or `Failed to connect`

**Possible causes:**
1. Server is not running  Start with `python3 server.py`
2. Wrong port  Verify server is listening on port 8443
3. Firewall blocking connection  Check firewall rules
4. mTLS disabled  Check `MTLS_ENABLED` environment variable

### Wrong Certificate Selected (Browser)

**Issue:** Browser doesn't prompt for certificate or selects wrong one

**Solution:**
- Clear browser certificate cache
- Chrome: Go to `chrome://restart`
- Firefox: Restart browser
- Ensure only one client certificate is installed for the domain

### Certificate Format Conversion

**Convert PEM to PKCS#12:**
```bash
openssl pkcs12 -export \
  -in certs/clients/client-<name>-cert.pem \
  -inkey certs/clients/client-<name>-key.pem \
  -out client.p12
```

**Convert PKCS#12 to PEM:**
```bash
openssl pkcs12 -in client.p12 -out client-cert.pem -clcerts -nokeys
openssl pkcs12 -in client.p12 -out client-key.pem -nocerts -nodes
```

**Convert PEM to DER:**
```bash
openssl x509 -in client-cert.pem -outform DER -out client-cert.der
```

---

## Security Best Practices

### Protect Your Private Key

- **Never share** your private key file (`client-<name>-key.pem`)
- **Set restrictive permissions:**
  ```bash
  chmod 600 certs/clients/client-<name>-key.pem
  ```
- **Encrypt the key** (optional):
  ```bash
  openssl rsa -aes256 -in client-key.pem -out client-key-encrypted.pem
  ```

### Certificate Storage

- Store certificates in a secure location (avoid public directories)
- Use hardware security modules (HSM) for production
- Consider using operating system credential stores:
  - Windows: Certificate Store
  - macOS: Keychain
  - Linux: GNOME Keyring or KWallet

### Monitor Expiration

**Check certificate expiration:**
```bash
openssl x509 -in certs/clients/client-<name>-cert.pem -noout -enddate
```

**Set up expiration alerts:**
- Client certificates expire after 1 year
- Renew certificates 30 days before expiration
- Use calendar reminders or monitoring tools

### Certificate Revocation

If your certificate is compromised:

1. **Notify administrator** immediately
2. **Generate new certificate:**
   ```bash
   ./generate-certs.sh --client-only --name <your-name>-new
   ```
3. **Delete old certificate** from all devices
4. **Update applications** with new certificate

---

## Quick Reference

### File Locations

| File | Purpose | Location |
|------|---------|----------|
| CA Certificate | Verify server identity | `certs/ca/ca-cert.pem` |
| Client Certificate | Your identity | `certs/clients/client-<name>-cert.pem` |
| Client Private Key | Your private key | `certs/clients/client-<name>-key.pem` |
| PKCS#12 Bundle | Browser import | `certs/clients/client-<name>.p12` |

### Common Commands

```bash
# Test connection
curl https://localhost:8443/ --cert client-cert.pem --key client-key.pem --cacert ca-cert.pem

# Verify certificate
openssl verify -CAfile ca-cert.pem client-cert.pem

# Check expiration
openssl x509 -in client-cert.pem -noout -enddate

# Generate new client certificate
./generate-certs.sh --client-only --name <name>
```

---

## Support

For additional assistance:
1. Check server logs for detailed error messages
2. Verify certificate validity and permissions
3. Ensure server is running with mTLS enabled
4. Review the `design.md` for mTLS architecture details
